name: build-spleeterrt
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-mac-arm:
    name: Build SpleeterRT for macOS ARM (Apple Silicon)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Compile all source files
          clang -O3 -std=c11 -Wall -Wextra \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            -o spleeterrt-offline \
            -lsamplerate \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          ./spleeterrt-offline --help || echo "Help displayed (expected error without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-arm-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: spleeterrt-macos-arm-v1.5.tar.gz

  build-mac-intel:
    name: Build SpleeterRT for macOS Intel
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Compile all source files
          clang -O3 -std=c11 -Wall -Wextra \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            -o spleeterrt-offline \
            -lsamplerate \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          ./spleeterrt-offline --help || echo "Help displayed (expected error without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: spleeterrt-macos-v1.5.tar.gz

  release:
    name: Create SpleeterRT Release
    needs: [build-mac-arm, build-mac-intel]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: ./artifacts
      
      - run: ls -la ./artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}-rt
          name: SpleeterRT ${{ github.ref_name }}
          body: |
            ## SpleeterRT ${{ github.ref_name }}
            
            Ultra-fast 4-stem audio separation (pure C implementation).
            
            ### Features
            - ~1.4x real-time separation speed
            - Pure Wiener pipeline
            - Bass mode options (--bass-mode=baseline)
            - High-band projection (--vocal-drum-sub=1)
            - Drum hiss gate (--drum-hiss=2)
            
            ### Downloads
            | Platform | File | Notes |
            |----------|------|-------|
            | macOS ARM (Apple Silicon) | spleeterrt-macos-arm-v1.5.tar.gz | Native ARM build |
            | macOS Intel | spleeterrt-macos-v1.5.tar.gz | Intel x86_64 |
            
            ### Models (separate download)
            Download models from the main release: `spleeterrt-models-v1.5.tar.gz`
            
            ### Usage
            ```bash
            tar -xzf spleeterrt-macos-arm-v1.5.tar.gz
            ./spleeterrt-offline input.wav output_dir/
            ```
          files: |
            ./artifacts/spleeterrt-macos-arm-v1.5.tar.gz
            ./artifacts/spleeterrt-macos-v1.5.tar.gz
          draft: false
          prerelease: false

name: build-spleeterrt
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-mac-arm:
    name: Build SpleeterRT for macOS ARM (Apple Silicon)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Get libsamplerate paths from homebrew
          SAMPLERATE_PREFIX=$(brew --prefix libsamplerate)
          
          # Find static library path
          SAMPLERATE_STATIC="${SAMPLERATE_PREFIX}/lib/libsamplerate.a"
          echo "Static library: ${SAMPLERATE_STATIC}"
          ls -la "${SAMPLERATE_STATIC}" || echo "Static lib not found, will try to build from source"
          
          # Compile all source files with deprecation warning suppression
          clang -O3 -std=c11 -Wall -Wextra -Wno-deprecated-declarations \
            -DACCELERATE_NEW_LAPACK \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -I${SAMPLERATE_PREFIX}/include \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything with STATIC libsamplerate (no runtime dependency)
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            "${SAMPLERATE_STATIC}" \
            -o spleeterrt-offline \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          # Check that libsamplerate is NOT a dynamic dependency
          echo "Checking dynamic dependencies:"
          otool -L spleeterrt-offline
          ./spleeterrt-offline --help 2>&1 || echo "Help displayed (expected without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-arm-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: spleeterrt-macos-arm-v1.5.tar.gz

  build-mac-intel:
    name: Build SpleeterRT for macOS Intel
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Get libsamplerate paths from homebrew
          SAMPLERATE_PREFIX=$(brew --prefix libsamplerate)
          
          # Find static library path
          SAMPLERATE_STATIC="${SAMPLERATE_PREFIX}/lib/libsamplerate.a"
          echo "Static library: ${SAMPLERATE_STATIC}"
          ls -la "${SAMPLERATE_STATIC}" || echo "Static lib not found"
          
          # Compile all source files with deprecation warning suppression
          clang -O3 -std=c11 -Wall -Wextra -Wno-deprecated-declarations \
            -DACCELERATE_NEW_LAPACK \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -I${SAMPLERATE_PREFIX}/include \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything with STATIC libsamplerate (no runtime dependency)
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            "${SAMPLERATE_STATIC}" \
            -o spleeterrt-offline \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          # Check that libsamplerate is NOT a dynamic dependency
          echo "Checking dynamic dependencies:"
          otool -L spleeterrt-offline
          ./spleeterrt-offline --help 2>&1 || echo "Help displayed (expected without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: spleeterrt-macos-v1.5.tar.gz

  build-windows:
    name: Build SpleeterRT for Windows
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            zip
      
      - name: Install OpenBLAS
        run: |
          pacman -S mingw-w64-x86_64-openblas --noconfirm
      
      - name: Build SpleeterRT with OpenBLAS
        run: |
          cd spleeterrt
          
          # Compile all source files with OpenBLAS support
          # OpenBLAS provides 10-40x speedup over pure C implementation
          
          gcc -O3 -std=c11 -fopenmp -DUSE_OPENBLAS -Wall \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          gcc -O3 -std=c11 -fopenmp -DUSE_OPENBLAS -c src/spleeter.c -o spleeter.o -Isrc
          gcc -O3 -std=c11 -fopenmp -DUSE_OPENBLAS -c src/stftFix.c -o stftFix.o -Isrc
          gcc -O3 -std=c11 -fopenmp -c src/codelet.c -o codelet.o -Isrc
          gcc -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          gcc -O3 -std=c11 -fopenmp -DUSE_OPENBLAS -c src/gemm.c -o gemm.o -Isrc
          gcc -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Compile embedded libsamplerate
          gcc -O3 -std=c11 -Ithird_party/libsamplerate \
            -c third_party/libsamplerate/samplerate.c -o samplerate.o
          gcc -O3 -std=c11 -Ithird_party/libsamplerate \
            -c third_party/libsamplerate/src_sinc.c -o src_sinc.o
          
          # Link with OpenBLAS (dynamic linking, DLLs bundled in package)
          gcc -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            samplerate.o src_sinc.o \
            -o spleeterrt-offline.exe \
            -lopenblas -lm -fopenmp
          
          ls -la spleeterrt-offline.exe
          
          # Copy required DLLs for distribution
          cp /mingw64/bin/libopenblas.dll .
          cp /mingw64/bin/libgomp-1.dll .
          cp /mingw64/bin/libwinpthread-1.dll .
          
          echo "Bundle contents:"
          ls -la *.exe *.dll
      
      - name: Verify build
        shell: pwsh
        run: |
          cd spleeterrt
          Write-Host "=== Files in bundle ==="
          Get-Item *.exe, *.dll | Select-Object Name, @{N='Size(MB)';E={[math]::Round($_.Length/1MB,2)}}
          Write-Host ""
          Write-Host "=== Testing executable ==="
          # The exe returns error code when given --help (not an audio file), so we capture output and ignore exit code
          $output = & .\spleeterrt-offline.exe --help 2>&1
          Write-Host $output
          if ($output -match "SpleeterRT") {
            Write-Host "Build verification PASSED - SpleeterRT executable works!"
            exit 0
          } else {
            Write-Host "Build verification FAILED - executable not working"
            exit 1
          }
      
      - name: Package
        run: |
          cd spleeterrt
          # Include exe and all required DLLs in the zip
          zip -j ../spleeterrt-win-v1.5.zip spleeterrt-offline.exe libopenblas.dll libgomp-1.dll libwinpthread-1.dll
          echo "Package created successfully!"
          ls -la ../spleeterrt-win-v1.5.zip
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-windows
          path: spleeterrt-win-v1.5.zip

  release:
    name: Create SpleeterRT Release
    needs: [build-mac-arm, build-mac-intel, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-windows
          path: ./artifacts
      
      - run: ls -la ./artifacts/
      
      - name: Update main-rt Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: main-rt
          name: SpleeterRT main-rt
          body: |
            ## SpleeterRT (Static Build)
            
            Ultra-fast 4-stem audio separation (pure C implementation).
            Now with **Windows support**! ðŸŽ‰
            **Static libsamplerate linking - no Homebrew dependencies required!**
            
            ### Features
            - ~1.4x real-time separation speed
            - Pure Wiener pipeline
            - Bass mode options (--bass-mode=baseline)
            - High-band projection (--vocal-drum-sub=1)
            - Drum hiss gate (--drum-hiss=2)
            
            ### Downloads
            | Platform | File | Notes |
            |----------|------|-------|
            | macOS ARM (Apple Silicon) | spleeterrt-macos-arm-v1.5.tar.gz | Native ARM build |
            | macOS Intel | spleeterrt-macos-v1.5.tar.gz | Intel x86_64 |
            | **Windows** | **spleeterrt-win-v1.5.zip** | **Windows 10/11 x64** |
            
            ### Models (separate download)
            Download models from the main release: `spleeterrt-models-v1.5.tar.gz`
            
            ### Usage (macOS)
            ```bash
            tar -xzf spleeterrt-macos-arm-v1.5.tar.gz
            ./spleeterrt-offline input.wav output_dir/
            ```
            
            ### Usage (Windows)
            ```cmd
            :: Extract spleeterrt-win-v1.5.zip
            spleeterrt-offline.exe input.wav output_dir\
            ```
          files: |
            ./artifacts/spleeterrt-macos-arm-v1.5.tar.gz
            ./artifacts/spleeterrt-macos-v1.5.tar.gz
            ./artifacts/spleeterrt-win-v1.5.zip
          draft: false
          prerelease: false

name: build-spleeterrt
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-mac-arm:
    name: Build SpleeterRT for macOS ARM (Apple Silicon)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Get libsamplerate paths from homebrew
          SAMPLERATE_PREFIX=$(brew --prefix libsamplerate)
          
          # Find static library path
          SAMPLERATE_STATIC="${SAMPLERATE_PREFIX}/lib/libsamplerate.a"
          echo "Static library: ${SAMPLERATE_STATIC}"
          ls -la "${SAMPLERATE_STATIC}" || echo "Static lib not found, will try to build from source"
          
          # Compile all source files with deprecation warning suppression
          clang -O3 -std=c11 -Wall -Wextra -Wno-deprecated-declarations \
            -DACCELERATE_NEW_LAPACK \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -I${SAMPLERATE_PREFIX}/include \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything with STATIC libsamplerate (no runtime dependency)
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            "${SAMPLERATE_STATIC}" \
            -o spleeterrt-offline \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          # Check that libsamplerate is NOT a dynamic dependency
          echo "Checking dynamic dependencies:"
          otool -L spleeterrt-offline
          ./spleeterrt-offline --help 2>&1 || echo "Help displayed (expected without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-arm-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: spleeterrt-macos-arm-v1.5.tar.gz

  build-mac-intel:
    name: Build SpleeterRT for macOS Intel
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install dependencies
        run: |
          brew install libsamplerate
      
      - name: Build SpleeterRT
        run: |
          cd spleeterrt
          
          # Get libsamplerate paths from homebrew
          SAMPLERATE_PREFIX=$(brew --prefix libsamplerate)
          
          # Find static library path
          SAMPLERATE_STATIC="${SAMPLERATE_PREFIX}/lib/libsamplerate.a"
          echo "Static library: ${SAMPLERATE_STATIC}"
          ls -la "${SAMPLERATE_STATIC}" || echo "Static lib not found"
          
          # Compile all source files with deprecation warning suppression
          clang -O3 -std=c11 -Wall -Wextra -Wno-deprecated-declarations \
            -DACCELERATE_NEW_LAPACK \
            -Isrc -Ithird_party/dr_libs -Ithird_party/libsamplerate \
            -I${SAMPLERATE_PREFIX}/include \
            -c src/spleeterrt_4stems_offline_wiener.c -o spleeterrt_main.o
          
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/spleeter.c -o spleeter.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/stftFix.c -o stftFix.o -Isrc
          clang -O3 -std=c11 -c src/codelet.c -o codelet.o -Isrc
          clang -O3 -std=c11 -c src/cpthread.c -o cpthread.o -Isrc
          clang -O3 -std=c11 -Wno-deprecated-declarations -DACCELERATE_NEW_LAPACK -c src/gemm.c -o gemm.o -Isrc
          clang -O3 -std=c11 -c src/im2col_dilated.c -o im2col_dilated.o -Isrc
          
          # Link everything with STATIC libsamplerate (no runtime dependency)
          clang -O3 \
            spleeterrt_main.o spleeter.o stftFix.o codelet.o cpthread.o gemm.o im2col_dilated.o \
            "${SAMPLERATE_STATIC}" \
            -o spleeterrt-offline \
            -framework Accelerate \
            -lm -lpthread
          
          chmod +x spleeterrt-offline
      
      - name: Verify build
        run: |
          cd spleeterrt
          file spleeterrt-offline
          # Check that libsamplerate is NOT a dynamic dependency
          echo "Checking dynamic dependencies:"
          otool -L spleeterrt-offline
          ./spleeterrt-offline --help 2>&1 || echo "Help displayed (expected without models)"
      
      - name: Package
        run: |
          cd spleeterrt
          tar -czf ../spleeterrt-macos-v1.5.tar.gz spleeterrt-offline
      
      - uses: actions/upload-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: spleeterrt-macos-v1.5.tar.gz

  release:
    name: Update SpleeterRT Release
    needs: [build-mac-arm, build-mac-intel]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-arm
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: spleeterrt-macos-intel
          path: ./artifacts
      
      - run: ls -la ./artifacts/
      
      - name: Update main-rt Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: main-rt
          name: SpleeterRT main-rt
          body: |
            ## SpleeterRT (Static Build)
            
            Ultra-fast 4-stem audio separation (pure C implementation).
            **Now with static libsamplerate linking - no Homebrew dependencies required!**
            
            ### Features
            - ~1.4x real-time separation speed
            - Pure Wiener pipeline
            - Bass mode options (--bass-mode=baseline)
            - High-band projection (--vocal-drum-sub=1)
            - Drum hiss gate (--drum-hiss=2)
            
            ### Downloads
            | Platform | File | Notes |
            |----------|------|-------|
            | macOS ARM (Apple Silicon) | spleeterrt-macos-arm-v1.5.tar.gz | Native ARM build |
            | macOS Intel | spleeterrt-macos-v1.5.tar.gz | Intel x86_64 |
            
            ### Models (separate download)
            Download models from the main release: `spleeterrt-models-v1.5.tar.gz`
            
            ### Usage
            ```bash
            tar -xzf spleeterrt-macos-arm-v1.5.tar.gz
            ./spleeterrt-offline input.wav output_dir/
            ```
          files: |
            ./artifacts/spleeterrt-macos-arm-v1.5.tar.gz
            ./artifacts/spleeterrt-macos-v1.5.tar.gz
          draft: false
          prerelease: false
